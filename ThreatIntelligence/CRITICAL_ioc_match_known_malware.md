# Threat Intelligence - IOC Match with Known Malware

## Severity
**CRITICAL**

## Description
Detects when internal systems communicate with known malicious IPs, domains, or file hashes from threat intelligence feeds, indicating active compromise or malware infection.

## MITRE ATT&CK
- **Tactic**: Command and Control (TA0011), Exfiltration (TA0010)
- **Technique**: Application Layer Protocol (T1071), Web Protocols (T1071.001), Exfiltration Over C2 Channel (T1041)

## DEVO Query

```sql
-- Correlate network traffic with threat intelligence feeds
from firewall.traffic, proxy.logs, dns.logs
where (dstip in (select ioc from threatintel.malicious_ips where confidence >= 80)
  or domain in (select ioc from threatintel.malicious_domains where confidence >= 80)
  or url in (select ioc from threatintel.malicious_urls where confidence >= 75))
  and action in ("allow", "allowed", "permit")
select
  eventdate,
  srcip,
  srchost,
  dstip,
  domain,
  url,
  threatintel.malicious_ips.threat_type,
  threatintel.malicious_ips.malware_family,
  threatintel.malicious_ips.threat_actor,
  threatintel.malicious_ips.first_seen,
  threatintel.malicious_ips.confidence_score,
  threatintel.malicious_ips.source_feed,
  bytes_sent,
  bytes_received,
  user
group by srcip, dstip, domain
-- Also check file hashes
union
from edr.file_events, email.attachments
where file_hash in (select ioc from threatintel.malicious_hashes where confidence >= 85)
select
  eventdate,
  hostname as srchost,
  filename,
  file_hash,
  file_path,
  threatintel.malicious_hashes.malware_family,
  threatintel.malicious_hashes.threat_type,
  threatintel.malicious_hashes.confidence_score
group by srchost, file_hash
```

## Alert Configuration
- **Trigger**: Any communication with high-confidence threat intel IOC
- **Throttling**: Real-time, no throttling
- **Severity**: Critical
- **Priority**: P1

## Recommended Actions
1. **IMMEDIATE**: Isolate affected system from network
2. Block IOC at all security controls (firewall, proxy, DNS)
3. Identify malware family and capabilities
4. Scan affected system with EDR/AV
5. Review all communications with the IOC
6. Check for data exfiltration
7. Hunt for additional infected systems
8. Review threat intelligence context
9. Collect forensic artifacts
10. Reset credentials for affected user/system
11. Update security controls with IOCs
12. Submit samples to threat intelligence platforms

## False Positive Considerations
- Threat intel feed false positives
- Sinkholed domains (security research)
- Legitimate sites flagged incorrectly
- CDN/cloud IPs shared with malicious content
- Outdated threat intelligence

**Tuning Recommendations**:
- Use high confidence scores (>75-80%)
- Whitelist known false positives by feed
- Cross-reference multiple TI sources
- Exclude security research/honeypot IPs
- Age out old indicators (>90 days)
- Verify current threat status

## Enrichment Opportunities
- Query additional threat intelligence sources
- Check VirusTotal, AlienVault OTX, MISP
- Review OSINT for malware family
- Correlate with recent security advisories
- Check for exploit kit associations
- Review related IOCs (same campaign)
- Analyze malware sandbox reports
- Check for APT attribution

## Response Playbook
1. **Immediate Containment** (0-5 min):
   - Network isolation
   - Block IOC globally
   - Alert security team
   - Preserve evidence

2. **Threat Analysis** (5-30 min):
   - Identify malware family
   - Review threat actor profile
   - Understand malware capabilities
   - Check campaign context
   - Review related IOCs

3. **Impact Assessment** (30 min - 2 hours):
   - Data exfiltration check
   - Lateral movement review
   - Credential compromise assessment
   - Persistence mechanism search
   - Scope of infection

4. **Investigation** (2-8 hours):
   - Full forensic analysis
   - Timeline reconstruction
   - Initial infection vector
   - All affected systems
   - Data accessed/stolen

5. **Eradication** (8-24 hours):
   - Malware removal
   - Persistence clearing
   - Vulnerability patching
   - Credential resets
   - System hardening

6. **Recovery & Monitoring**:
   - System restoration
   - Enhanced monitoring
   - IOC blocking
   - User notification
   - Documentation

## Investigation Steps
- Review complete communication history with IOC
- Identify first contact timestamp
- Check data transfer volumes
- Analyze malware family characteristics
- Review threat actor TTPs
- Search for additional IOCs from same campaign
- Check for beacon patterns
- Review DNS queries to C2 domains
- Analyze SSL certificates used
- Check for protocol anomalies

## Threat Intelligence Sources

**Commercial Feeds**:
- Recorded Future
- Anomali ThreatStream
- CrowdStrike Falcon Intelligence
- FireEye iSIGHT
- Palo Alto AutoFocus
- Cisco Talos

**Open Source Feeds**:
- AlienVault OTX
- MISP Communities
- Abuse.ch (Feodo, URLhaus, ThreatFox)
- OpenPhish
- PhishTank
- EmergingThreats
- SANS ISC

**Government Sources**:
- US-CERT
- CISA alerts
- FBI FLASH
- NCSC

## IOC Types

**Network Indicators**:
- IP addresses (C2 servers)
- Domain names (malicious/phishing)
- URLs (exploit kits, phishing)
- SSL certificate hashes
- JA3/JA3S fingerprints

**File Indicators**:
- MD5, SHA1, SHA256 hashes
- File names (known malware)
- File paths (common locations)
- Mutex names
- Registry keys

**Email Indicators**:
- Sender addresses
- Subject lines
- Attachment names
- Email headers

**Behavioral Indicators**:
- Process patterns
- Command lines
- Network behaviors
- Registry modifications

## Confidence Score Interpretation

- **90-100%**: Confirmed malicious, act immediately
- **75-89%**: High confidence, investigate urgently
- **50-74%**: Medium confidence, monitor and investigate
- **Below 50%**: Low confidence, context-dependent

## Malware Family Context

When malware family is identified, research:
- Primary objectives (RAT, stealer, ransomware, etc.)
- Typical infection vectors
- Known C2 infrastructure
- Data theft capabilities
- Lateral movement techniques
- Persistence mechanisms
- Decryption/removal tools available
- Associated threat actors
- Industry targeting patterns

## Enhanced Detection

```sql
-- Detect multiple IOC hits from same source
from firewall.traffic
where dstip in (select ioc from threatintel.malicious_ips)
select
  srcip,
  countdistinct(dstip) as unique_malicious_ips,
  count() as connection_attempts,
  collectdistinct(threatintel.malicious_ips.malware_family) as families
group by srcip
every 1h
having unique_malicious_ips >= 3
```

## Threat Intelligence Feed Management

**Best Practices**:
- Use multiple feed sources
- Implement confidence scoring
- Age out old indicators
- Deduplicate across feeds
- Track false positive rates
- Document feed performance
- Regular feed review
- Automated feed updates

**Feed Refresh Frequency**:
- Critical feeds: Every 5-15 minutes
- Standard feeds: Hourly
- Bulk feeds: Daily
- Historical data: Weekly

## Automation Opportunities
- Auto-block high-confidence IOCs
- Automatic ticket creation
- SOAR playbook execution
- IOC sharing with partners
- Threat intel platform updates
- Cross-security tool blocking
- Automated forensic collection
- User/system isolation

## Threat Actor Context

If attributed to known threat actor:
- Review actor's typical TTPs
- Check for targeted industries
- Understand motivation (financial, espionage, etc.)
- Review historical campaigns
- Check geopolitical context
- Assess sophistication level
- Review known toolsets
- Understand dwell time patterns

## Data Exfiltration Assessment

Check for:
- Unusual data volumes to IOC
- Database queries before contact
- File access patterns
- Compression/encryption activity
- Staging directories
- Cloud storage uploads
- Email with large attachments

## Lateral Movement Indicators

After IOC match, hunt for:
- SMB connections from infected host
- RDP sessions to other systems
- WMI remote execution
- PowerShell remoting
- Credential dumping attempts
- Privilege escalation
- New admin accounts

## Communication Patterns

Analyze C2 communication:
- Beaconing intervals (regular/irregular)
- Data transfer volumes
- Protocol usage (HTTP, HTTPS, DNS)
- User-agent strings
- Connection timing
- Encryption methods
- Domain generation algorithms (DGA)

## Incident Metrics

Track:
- Time to detection
- Time to containment
- Number of systems affected
- Data exfiltration volume
- Dwell time
- Eradication time
- Cost of incident
- IOC effectiveness

## Legal/Compliance
- Document all findings
- Preserve evidence chain of custody
- Notify legal team if data breach
- Regulatory reporting requirements
- Law enforcement coordination
- Cyber insurance notification
- Third-party disclosure obligations

## Notes
- Threat intel is critical for proactive defense
- Context matters more than IOC alone
- High-confidence IOCs warrant immediate action
- Share findings with threat intel community
- Continuous feed tuning is essential
- Combine with behavior analytics for best results
