# Checkpoint - Threat Emulation Malware Detection

## Severity
**CRITICAL**

## Description
Detects malware identified by Checkpoint Threat Emulation (sandboxing) which executes suspicious files in a virtualized environment to identify zero-day threats.

## MITRE ATT&CK
- **Tactic**: Initial Access (TA0001), Execution (TA0002)
- **Technique**: User Execution (T1204), Malicious File (T1204.002)

## DEVO Query

```sql
from firewall.checkpoint.threat
select eventdate
select src as srcaddr
select dst as dstaddr
select src_user_name
select service
select file_name
select file_hash
select file_type
select threat_name
select malware_family
select verdict
select threat_severity
select threat_prevention_action
select protection_name
select emulation_verdict
select mm2country(src) as src_country
select mm2country(dst) as dst_country
select purpose(src) as src_purpose
where weakhas(product, "Threat Emulation")
  and `in`("prevented", "detected", threat_prevention_action)
  and `in`("Critical", "High", threat_severity)
  and (weakhas(verdict, "malicious") or confidence_level >= 3)
group by src, dst, file_hash, threat_name
```

## Alert Configuration
- **Trigger**: Any match
- **Throttling**: 1 alert per file_hash per 30 minutes
- **Severity**: Critical
- **Priority**: P1

## Recommended Actions
1. **IMMEDIATE**: Quarantine/delete malicious file
2. Isolate affected endpoint
3. Block file hash globally (AV, EDR, firewall)
4. Identify file source (email, web, USB, etc.)
5. Check if file was executed on endpoint
6. Scan affected system with EDR
7. Review all recent file downloads by same user
8. Reset user credentials if compromise suspected
9. Hunt for file hash across environment
10. Submit to threat intelligence platforms

## False Positive Considerations
- Rare with sandbox analysis
- Legitimate software with suspicious behavior
- Packed/obfuscated legitimate files
- Security tools and utilities

**Tuning Recommendations**:
- Whitelist known security tools by hash
- Exclude approved software deployment paths
- Very low false positive rate for malicious verdicts
- Review medium confidence detections separately

## Enrichment Opportunities
- Correlate with email security logs
- Check web proxy for download source
- Review endpoint execution logs
- Cross-reference with VirusTotal
- Analyze OSINT for malware family information
- Check for related IOCs

## Response Playbook
1. Confirm malware verdict and severity
2. Immediately contain affected systems
3. Identify infection vector
4. Check for execution and persistence
5. Capture forensic evidence
6. Eradicate malware and artifacts
7. Reset compromised credentials
8. Hunt for lateral movement
9. Update all security controls with IOCs
10. Conduct post-incident review

## Threat Emulation Features
- Zero-day detection
- Advanced evasion techniques identification
- Behavioral analysis
- Multiple OS emulation
- Document exploit detection
- Suspicious macro detection

## File Types Commonly Analyzed
- Executables (.exe, .dll, .scr)
- Office documents (.doc, .xls, .ppt)
- PDFs
- Archives (.zip, .rar, .7z)
- Scripts (.js, .vbs, .ps1)
- Android APKs

## Indicators to Collect
- File hash (MD5, SHA256)
- File name and path
- Source URL or email
- User who downloaded/received
- Execution timeline
- Network connections made
- Registry modifications
- Dropped files

## Integration Points
- Share IOCs with threat intelligence platform
- Auto-quarantine in email system
- Block hash in EDR
- Update firewall signatures
- Feed to SOAR for automated response

## Notes
- Threat Emulation is high-fidelity detection
- Assume compromise if file was executed
- Time-sensitive - act within minutes
- Document for threat intelligence
